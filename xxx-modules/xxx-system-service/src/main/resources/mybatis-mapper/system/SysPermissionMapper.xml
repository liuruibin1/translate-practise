<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xxx.system.mapper.SysPermissionMapper">

    <sql id="querySelect">
        <![CDATA[
            SELECT tall.*
            FROM (SELECT sp_.*
                       , p_sp_.type AS parent_type
                       , p_sp_.name AS parent_name
                  FROM sys_permission sp_
                           LEFT JOIN sys_permission p_sp_ ON sp_.parent_id = p_sp_.id
                 ) tall
        ]]>
    </sql>

    <sql id="queryWhere">
        <where>
            <!-- id -->
            tall.id IS NOT NULL

            <!-- id -->
            <if test="paramObj.id != null">
                AND tall.id = #{paramObj.id}
            </if>

            <!-- parent_id -->
            <if test="paramObj.parentId != null">
                AND tall.parent_id = #{paramObj.parentId}
            </if>

            <!-- type -->
            <if test="paramObj.type != null">
                AND tall.type = #{paramObj.type}
            </if>

            <!-- name -->
            <if test="paramObj.name != null and !paramObj.name.isEmpty()">
                AND LOWER(tall.name) LIKE CONCAT('%', LOWER(#{paramObj.name}), '%')
            </if>

            <!-- code -->
            <if test="paramObj.code != null and !paramObj.code.isEmpty()">
                AND LOWER(tall.code) LIKE CONCAT('%', LOWER(#{paramObj.code}), '%')
            </if>

            <!-- url_path -->
            <!-- url_query -->
            <!-- page_component -->
            <!-- icon -->

            <!-- is_cache -->
            <if test="paramObj.isCache != null">
                AND tall.is_cache = #{paramObj.isCache}
            </if>

            <!-- is_visible -->
            <if test="paramObj.isVisible != null">
                AND tall.is_visible = #{paramObj.isVisible}
            </if>

            <!-- is_page_frame -->
            <if test="paramObj.isPageFrame != null">
                AND tall.is_page_frame = #{paramObj.isPageFrame}
            </if>

            <!-- is_enabled -->
            <if test="paramObj.isEnabled != null">
                AND tall.is_enabled = #{paramObj.isEnabled}
            </if>

            <!-- sort -->
            <if test="paramObj.sort != null">
                AND tall.sort = #{paramObj.sort}
            </if>

            <!-- update_ts -->

            <!-- 其它字段 -->

            <if test="paramObj.key != null and !paramObj.key.isEmpty()">
                <![CDATA[
                    AND (
                            LOWER(tall.name) LIKE CONCAT('%', LOWER(#{paramObj.key}), '%')
                            OR LOWER(tall.code) LIKE CONCAT('%', LOWER(#{paramObj.key}), '%')
                        )
                ]]>
            </if>

        </where>
    </sql>

    <sql id="queryOrderBy">
        ORDER BY tall.sort
    </sql>

    <select id="queryList" parameterType="java.util.Map" resultType="com.xxx.system.vo.SysPermissionVO">
        <include refid="querySelect"/>
        <include refid="queryWhere"/>
        <include refid="queryOrderBy"/>
    </select>

</mapper>